<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿è©¦æ¨¡å¼ - æ™šé¤é¸æ“‡å™¨</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; }
        .result { background: #e8f4fd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffeaea; padding: 15px; margin: 10px 0; border-radius: 5px; }
        pre { background: #f8f8f8; padding: 10px; overflow-x: auto; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ” èª¿è©¦æ¨¡å¼</h1>
    
    <div class="test">
        <h2>åœ°å€æ¸¬è©¦</h2>
        <input type="text" id="address-test" value="å°åŒ—è»Šç«™" style="width: 200px; padding: 8px;">
        <button onclick="testAddress()">æ¸¬è©¦åœ°å€æœå°‹</button>
        <div id="address-result"></div>
    </div>

    <div class="test">
        <h2>é¤å»³æœå°‹æ¸¬è©¦</h2>
        <p>ç·¯åº¦: <input type="number" id="lat-test" value="25.0478" step="any" style="width: 100px; padding: 5px;"></p>
        <p>ç¶“åº¦: <input type="number" id="lng-test" value="121.5168" step="any" style="width: 100px; padding: 5px;"></p>
        <button onclick="testRestaurants()">æ¸¬è©¦é¤å»³æœå°‹</button>
        <div id="restaurant-result"></div>
    </div>

    <div class="test">
        <h2>å®Œæ•´æµç¨‹æ¸¬è©¦</h2>
        <input type="text" id="full-test-address" value="å°åŒ—è»Šç«™" style="width: 200px; padding: 8px;">
        <button onclick="testFullFlow()">å®Œæ•´æ¸¬è©¦</button>
        <div id="full-result"></div>
    </div>

    <script>
        async function testAddress() {
            const address = document.getElementById('address-test').value;
            const resultDiv = document.getElementById('address-result');
            resultDiv.innerHTML = '<div class="result">æœå°‹ä¸­...</div>';
            
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=3&accept-language=zh-TW,zh,en`;
                console.log('Testing URL:', url);
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'RestaurantSelector/1.0' }
                });
                
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h4>âœ… æˆåŠŸæ‰¾åˆ°åœ°å€</h4>
                            <p><strong>åç¨±:</strong> ${result.display_name}</p>
                            <p><strong>åº§æ¨™:</strong> ${result.lat}, ${result.lon}</p>
                            <details>
                                <summary>å®Œæ•´è³‡æ–™</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">âŒ æ²’æœ‰æ‰¾åˆ°çµæœ</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        async function testRestaurants() {
            const lat = parseFloat(document.getElementById('lat-test').value);
            const lng = parseFloat(document.getElementById('lng-test').value);
            const resultDiv = document.getElementById('restaurant-result');
            
            resultDiv.innerHTML = '<div class="result">æœå°‹é¤å»³ä¸­...</div>';
            
            try {
                const radius = 2000;
                const latDelta = radius / 111320;
                const lngDelta = radius / (111320 * Math.cos(lat * Math.PI / 180));
                
                const south = lat - latDelta;
                const north = lat + latDelta;
                const west = lng - lngDelta;
                const east = lng + lngDelta;

                const query = `
                [out:json][timeout:15];
                (
                  node["amenity"="restaurant"](${south},${west},${north},${east});
                  node["amenity"="fast_food"](${south},${west},${north},${east});
                  node["amenity"="cafe"](${south},${west},${north},${east});
                );
                out;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query,
                    headers: { 'Content-Type': 'text/plain', 'User-Agent': 'RestaurantSelector/1.0' }
                });

                const data = await response.json();
                const restaurants = data.elements.filter(e => e.tags && e.tags.name);

                if (restaurants.length > 0) {
                    let html = `<div class="result"><h4>âœ… æ‰¾åˆ° ${restaurants.length} å®¶é¤å»³</h4><ul>`;
                    restaurants.slice(0, 10).forEach(r => {
                        html += `<li><strong>${r.tags.name}</strong> - ${r.tags.amenity}</li>`;
                    });
                    html += '</ul></div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">âŒ æ²’æœ‰æ‰¾åˆ°é¤å»³</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        async function testFullFlow() {
            const address = document.getElementById('full-test-address').value;
            const resultDiv = document.getElementById('full-result');
            let log = [];
            
            try {
                resultDiv.innerHTML = '<div class="result">åŸ·è¡Œå®Œæ•´æµç¨‹æ¸¬è©¦...</div>';
                
                // Step 1: åœ°å€æœå°‹
                log.push('æ­¥é©Ÿ 1: æœå°‹åœ°å€');
                const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=zh-TW,zh,en`;
                const geoResponse = await fetch(geoUrl, {
                    headers: { 'User-Agent': 'RestaurantSelector/1.0' }
                });
                const geoData = await geoResponse.json();
                
                if (geoData.length === 0) {
                    throw new Error('æ‰¾ä¸åˆ°åœ°å€');
                }
                
                const location = geoData[0];
                const lat = parseFloat(location.lat);
                const lng = parseFloat(location.lon);
                log.push(`åœ°å€æ‰¾åˆ°: ${location.display_name} (${lat}, ${lng})`);
                
                // Step 2: æœå°‹é¤å»³
                log.push('æ­¥é©Ÿ 2: æœå°‹é¤å»³');
                const radius = 2000;
                const latDelta = radius / 111320;
                const lngDelta = radius / (111320 * Math.cos(lat * Math.PI / 180));
                
                const query = `
                [out:json][timeout:15];
                (
                  node["amenity"="restaurant"](${lat - latDelta},${lng - lngDelta},${lat + latDelta},${lng + lngDelta});
                  node["amenity"="fast_food"](${lat - latDelta},${lng - lngDelta},${lat + latDelta},${lng + lngDelta});
                );
                out;
                `;

                const restaurantResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query,
                    headers: { 'Content-Type': 'text/plain', 'User-Agent': 'RestaurantSelector/1.0' }
                });

                const restaurantData = await restaurantResponse.json();
                const restaurants = restaurantData.elements.filter(e => e.tags && e.tags.name);
                log.push(`æ‰¾åˆ° ${restaurants.length} å®¶é¤å»³`);
                
                if (restaurants.length > 0) {
                    const randomRestaurant = restaurants[Math.floor(Math.random() * restaurants.length)];
                    log.push(`éš¨æ©Ÿé¸æ“‡: ${randomRestaurant.tags.name}`);
                    
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h4>âœ… å®Œæ•´æµç¨‹æˆåŠŸï¼</h4>
                            <p><strong>æœ€çµ‚é¸æ“‡:</strong> ${randomRestaurant.tags.name}</p>
                            <p><strong>é¡å‹:</strong> ${randomRestaurant.tags.amenity}</p>
                            <details>
                                <summary>åŸ·è¡Œè¨˜éŒ„</summary>
                                <pre>${log.join('\n')}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°é¤å»³');
                }
                
            } catch (error) {
                log.push(`éŒ¯èª¤: ${error.message}`);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æµç¨‹å¤±æ•—</h4>
                        <p>${error.message}</p>
                        <details>
                            <summary>åŸ·è¡Œè¨˜éŒ„</summary>
                            <pre>${log.join('\n')}</pre>
                        </details>
                    </div>
                `;
            }
        }

        // è‡ªå‹•æ¸¬è©¦åœ°å€
        window.onload = function() {
            testAddress();
        };
    </script>
</body>
</html>