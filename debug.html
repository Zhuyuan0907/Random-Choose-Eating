<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>調試模式 - 晚餐選擇器</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; }
        .result { background: #e8f4fd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffeaea; padding: 15px; margin: 10px 0; border-radius: 5px; }
        pre { background: #f8f8f8; padding: 10px; overflow-x: auto; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>🔍 調試模式</h1>
    
    <div class="test">
        <h2>地址測試</h2>
        <input type="text" id="address-test" value="台北車站" style="width: 200px; padding: 8px;">
        <button onclick="testAddress()">測試地址搜尋</button>
        <div id="address-result"></div>
    </div>

    <div class="test">
        <h2>餐廳搜尋測試</h2>
        <p>緯度: <input type="number" id="lat-test" value="25.0478" step="any" style="width: 100px; padding: 5px;"></p>
        <p>經度: <input type="number" id="lng-test" value="121.5168" step="any" style="width: 100px; padding: 5px;"></p>
        <button onclick="testRestaurants()">測試餐廳搜尋</button>
        <div id="restaurant-result"></div>
    </div>

    <div class="test">
        <h2>完整流程測試</h2>
        <input type="text" id="full-test-address" value="台北車站" style="width: 200px; padding: 8px;">
        <button onclick="testFullFlow()">完整測試</button>
        <div id="full-result"></div>
    </div>

    <script>
        async function testAddress() {
            const address = document.getElementById('address-test').value;
            const resultDiv = document.getElementById('address-result');
            resultDiv.innerHTML = '<div class="result">搜尋中...</div>';
            
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=3&accept-language=zh-TW,zh,en`;
                console.log('Testing URL:', url);
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'RestaurantSelector/1.0' }
                });
                
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h4>✅ 成功找到地址</h4>
                            <p><strong>名稱:</strong> ${result.display_name}</p>
                            <p><strong>座標:</strong> ${result.lat}, ${result.lon}</p>
                            <details>
                                <summary>完整資料</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ 沒有找到結果</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 錯誤: ${error.message}</div>`;
            }
        }

        async function testRestaurants() {
            const lat = parseFloat(document.getElementById('lat-test').value);
            const lng = parseFloat(document.getElementById('lng-test').value);
            const resultDiv = document.getElementById('restaurant-result');
            
            resultDiv.innerHTML = '<div class="result">搜尋餐廳中...</div>';
            
            try {
                const radius = 2000;
                const latDelta = radius / 111320;
                const lngDelta = radius / (111320 * Math.cos(lat * Math.PI / 180));
                
                const south = lat - latDelta;
                const north = lat + latDelta;
                const west = lng - lngDelta;
                const east = lng + lngDelta;

                const query = `
                [out:json][timeout:15];
                (
                  node["amenity"="restaurant"](${south},${west},${north},${east});
                  node["amenity"="fast_food"](${south},${west},${north},${east});
                  node["amenity"="cafe"](${south},${west},${north},${east});
                );
                out;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query,
                    headers: { 'Content-Type': 'text/plain', 'User-Agent': 'RestaurantSelector/1.0' }
                });

                const data = await response.json();
                const restaurants = data.elements.filter(e => e.tags && e.tags.name);

                if (restaurants.length > 0) {
                    let html = `<div class="result"><h4>✅ 找到 ${restaurants.length} 家餐廳</h4><ul>`;
                    restaurants.slice(0, 10).forEach(r => {
                        html += `<li><strong>${r.tags.name}</strong> - ${r.tags.amenity}</li>`;
                    });
                    html += '</ul></div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ 沒有找到餐廳</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 錯誤: ${error.message}</div>`;
            }
        }

        async function testFullFlow() {
            const address = document.getElementById('full-test-address').value;
            const resultDiv = document.getElementById('full-result');
            let log = [];
            
            try {
                resultDiv.innerHTML = '<div class="result">執行完整流程測試...</div>';
                
                // Step 1: 地址搜尋
                log.push('步驟 1: 搜尋地址');
                const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=zh-TW,zh,en`;
                const geoResponse = await fetch(geoUrl, {
                    headers: { 'User-Agent': 'RestaurantSelector/1.0' }
                });
                const geoData = await geoResponse.json();
                
                if (geoData.length === 0) {
                    throw new Error('找不到地址');
                }
                
                const location = geoData[0];
                const lat = parseFloat(location.lat);
                const lng = parseFloat(location.lon);
                log.push(`地址找到: ${location.display_name} (${lat}, ${lng})`);
                
                // Step 2: 搜尋餐廳
                log.push('步驟 2: 搜尋餐廳');
                const radius = 2000;
                const latDelta = radius / 111320;
                const lngDelta = radius / (111320 * Math.cos(lat * Math.PI / 180));
                
                const query = `
                [out:json][timeout:15];
                (
                  node["amenity"="restaurant"](${lat - latDelta},${lng - lngDelta},${lat + latDelta},${lng + lngDelta});
                  node["amenity"="fast_food"](${lat - latDelta},${lng - lngDelta},${lat + latDelta},${lng + lngDelta});
                );
                out;
                `;

                const restaurantResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query,
                    headers: { 'Content-Type': 'text/plain', 'User-Agent': 'RestaurantSelector/1.0' }
                });

                const restaurantData = await restaurantResponse.json();
                const restaurants = restaurantData.elements.filter(e => e.tags && e.tags.name);
                log.push(`找到 ${restaurants.length} 家餐廳`);
                
                if (restaurants.length > 0) {
                    const randomRestaurant = restaurants[Math.floor(Math.random() * restaurants.length)];
                    log.push(`隨機選擇: ${randomRestaurant.tags.name}`);
                    
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h4>✅ 完整流程成功！</h4>
                            <p><strong>最終選擇:</strong> ${randomRestaurant.tags.name}</p>
                            <p><strong>類型:</strong> ${randomRestaurant.tags.amenity}</p>
                            <details>
                                <summary>執行記錄</summary>
                                <pre>${log.join('\n')}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error('沒有找到餐廳');
                }
                
            } catch (error) {
                log.push(`錯誤: ${error.message}`);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>❌ 流程失敗</h4>
                        <p>${error.message}</p>
                        <details>
                            <summary>執行記錄</summary>
                            <pre>${log.join('\n')}</pre>
                        </details>
                    </div>
                `;
            }
        }

        // 自動測試地址
        window.onload = function() {
            testAddress();
        };
    </script>
</body>
</html>